<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termometr DIY</title>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }
        .data-box { border: 1px solid #444; padding: 15px; margin-top: 20px; border-radius: 8px; }
        h1 { margin: 0 0 10px 0; font-size: 1.2rem; color: #fff; }
        .value { font-size: 2.5rem; font-weight: bold; }
        .label { color: #888; font-size: 0.9rem; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; font-size: 1rem; border-radius: 5px; cursor: pointer; width: 100%; }
        #log { font-size: 0.8rem; color: #666; margin-top: 20px; height: 100px; overflow-y: scroll; border-top: 1px solid #333; }
    </style>
</head>
<body>

    <button id="scanBtn">START SCANNING</button>

    <div id="display" style="display:none;">
        <div class="data-box">
            <div class="label">Temperatura</div>
            <div class="value"><span id="temp">--</span>°C</div>
        </div>
        <div class="data-box">
            <div class="label">Wilgotność</div>
            <div class="value"><span id="hum">--</span>%</div>
        </div>
        <div class="data-box">
            <div class="label">Bateria</div>
            <div class="value" style="font-size: 1.5rem;"><span id="batt">--</span>% (<span id="volt">--</span>mV)</div>
        </div>
        <div class="label" style="margin-top:10px;">Ostatni odczyt: <span id="lastup">--</span></div>
    </div>

    <div id="log"></div>

    <script>
        const scanBtn = document.getElementById('scanBtn');
        const logDiv = document.getElementById('log');

        const log = (msg) => {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
        };

        scanBtn.addEventListener('click', async () => {
            try {
                log('Szukam urządzeń z Service UUID 0x181A...');
                
                // 1. Prosimy użytkownika o wybranie urządzenia
                // Filtrujemy tylko urządzenia rozgłaszające serwis środowiskowy (0x181A)
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x181a] }]
                });

                log(`Wybrano: ${device.name}`);
                document.getElementById('display').style.display = 'block';
                scanBtn.style.display = 'none';

                // 2. Nasłuchujemy pasywnych reklam (Advertisement)
                // To kluczowe - nie łączymy się (GATT Connect), tylko słuchamy "krzyczenia"
                device.addEventListener('advertisementreceived', (event) => {
                    const data = event.serviceData.get(event.serviceUuids[0]); // Pobierz payload dla 0x181A
                    if (data) {
                        parseATC1441(data);
                    }
                });

                // 3. Start nasłuchiwania
                await device.watchAdvertisements();
                log('Nasłuchiwanie rozpoczęte! Czekam na pakiety...');

            } catch (error) {
                log(`Błąd: ${error}`);
                console.error(error);
            }
        });

        function parseATC1441(dataView) {
            // DataView pozwala łatwo czytać bajty
            // Format ATC1441:
            // Byte 6-7: Temp (Big Endian int16)
            // Byte 8: Humi (uint8)
            // Byte 9: Batt (uint8)
            // Byte 10-11: Volt (uint16)

            if (dataView.byteLength < 10) return;

            // Czytamy temperaturę (Big Endian = false w JS jest domyślnie Big Endian dla DataView? 
            // Nie, w JS DataView domyślnie jest Big Endian. Sprawdźmy to:
            // getInt16(byteOffset, littleEndian) -> default littleEndian is false (so Big Endian).
            // ATC wysyła Big Endian.
            const tempRaw = dataView.getInt16(6, false); 
            const temp = tempRaw / 10;

            const hum = dataView.getUint8(8);
            const batt = dataView.getUint8(9);
            const volt = dataView.getUint16(10, false); // Też Big Endian zazwyczaj w tym formacie

            updateUI(temp, hum, batt, volt);
        }

        function updateUI(temp, hum, batt, volt) {
            document.getElementById('temp').innerText = temp.toFixed(1);
            document.getElementById('hum').innerText = hum;
            document.getElementById('batt').innerText = batt;
            document.getElementById('volt').innerText = volt;
            document.getElementById('lastup').innerText = new Date().toLocaleTimeString();
            
            // Kolorowanie w zależności od temperatury (bajer)
            document.getElementById('temp').style.color = temp < 20 ? '#00ccff' : (temp > 25 ? '#ff3300' : '#0f0');
        }
    </script>
</body>
</html>
