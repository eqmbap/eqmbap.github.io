<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termometr DIY</title>
    <style>
        body { font-family: monospace; background: #222; color: #0f0; padding: 20px; }
        .data-box { border: 1px solid #444; padding: 15px; margin-top: 20px; border-radius: 8px; }
        h1 { margin: 0 0 10px 0; font-size: 1.2rem; color: #fff; }
        .value { font-size: 2.5rem; font-weight: bold; }
        .label { color: #888; font-size: 0.9rem; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; font-size: 1rem; border-radius: 5px; cursor: pointer; width: 100%; }
        #log { font-size: 0.8rem; color: #666; margin-top: 20px; height: 100px; overflow-y: scroll; border-top: 1px solid #333; }
    </style>
</head>
<body>

    <button id="scanBtn">START SCANNING 3</button>

    <div id="display" style="display:none;">
        <div class="data-box">
            <div class="label">Temperatura</div>
            <div class="value"><span id="temp">--</span>°C</div>
        </div>
        <div class="data-box">
            <div class="label">Wilgotność</div>
            <div class="value"><span id="hum">--</span>%</div>
        </div>
        <div class="data-box">
            <div class="label">Bateria</div>
            <div class="value" style="font-size: 1.5rem;"><span id="batt">--</span>% (<span id="volt">--</span>mV)</div>
        </div>
        <div class="label" style="margin-top:10px;">Ostatni odczyt: <span id="lastup">--</span></div>
    </div>

    <div id="log"></div>

<script>
        const scanBtn = document.getElementById('scanBtn');
        const logDiv = document.getElementById('log');

        // Funkcja pomocnicza do wyświetlania bajtów
        function buf2hex(buffer) { 
            return [...new Uint8Array(buffer)]
                .map(x => x.toString(16).padStart(2, '0'))
                .join(' ');
        }

        const log = (msg) => {
            const time = new Date().toLocaleTimeString();
            // Logujemy na górze, żeby nie przewijać
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
        };

        scanBtn.addEventListener('click', async () => {
            try {
                log('Startowanie...');
                
                // ZMIANA STRATEGII: Filtrujemy GŁÓWNIE po serwisie 0x181a.
                // To wymusi na Chrome szukanie pakietów z danymi, a nie tylko nazwą.
                const device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { services: [0x181a] } 
                    ],
                    // Dla pewności dodajemy też prefix nazwy jako alternatywny filtr w OR
                    optionalServices: [0x181a]
                });

                log(`Wybrano: ${device.name} (ID: ${device.id.slice(0,5)}...)`);
                
                document.getElementById('display').style.display = 'block';
                scanBtn.style.display = 'none';

                device.addEventListener('advertisementreceived', (event) => {
                    // DIAGNOSTYKA: Wypiszmy wszystko co przyszło
                    // log(`Odebrano ramkę! RSSI: ${event.rssi}`);
                    
                    const serviceData = event.serviceData;

                    // Iterujemy po wszystkich serwisach w ramce
                    serviceData.forEach((value, key) => {
                        // key to UUID (zazwyczaj długi string)
                        if (key.includes('181a')) {
                            // log(`Mamy 181a! RAW: ${buf2hex(value.buffer)}`);
                            parseATC1441(value);
                        } else {
                            log(`Inny serwis: ${key}`);
                        }
                    });
                });

                await device.watchAdvertisements();
                log('Zarejestrowano Watcher. Czekam na dane...');

            } catch (error) {
                log(`BŁĄD: ${error}`);
            }
        });

        function parseATC1441(dataView) {
            // Oczekujemy min. 13 bajtów w formacie ATC1441
            // Bajt 0-5: MAC
            // Bajt 6-7: Temp
            // Bajt 8: Humi
            // Bajt 9: Batt
            // Bajt 10-11: Volt
            
            if (dataView.byteLength < 10) {
                log(`Za krótki pakiet: ${dataView.byteLength}B`);
                return;
            }

            try {
                // Konwersja Big Endian (false w drugim argumencie)
                const tempRaw = dataView.getInt16(6, false); 
                const temp = tempRaw / 10;
                
                const hum = dataView.getUint8(8);
                const batt = dataView.getUint8(9);
                const volt = dataView.getUint16(10, false);

                // Aktualizacja UI
                updateUI(temp, hum, batt, volt);
                
                // Opcjonalnie: loguj raz na jakiś czas dla pewności
                // log(`Odczyt: ${temp}°C / ${hum}%`);

            } catch (e) {
                log(`Błąd parsowania: ${e}`);
            }
        }

        function updateUI(temp, hum, batt, volt) {
            document.getElementById('temp').innerText = temp.toFixed(1);
            document.getElementById('hum').innerText = hum;
            document.getElementById('batt').innerText = batt;
            document.getElementById('volt').innerText = volt;
            document.getElementById('lastup').innerText = new Date().toLocaleTimeString();
        }
    </script>
</body>
</html>
